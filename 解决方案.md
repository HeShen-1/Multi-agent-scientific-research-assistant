# 解决方案和故障排查指南

本文档提供了多智能体科研助手常见问题的解决方案、配置指南和技术细节。

## 🚨 常见错误及解决方案

### 1. `LLM Provider NOT provided` 错误

**错误信息：**
```
litellm.BadRequestError: LLM Provider NOT provided. 
Pass in the LLM provider you are trying to call. You passed model=deepseek-chat
```

**根本原因：**
CrewAI内部使用LiteLLM来处理各种LLM提供商，但LiteLLM无法识别`deepseek-chat`这个模型名称，不知道应该使用哪个提供商来处理请求。

**解决方案：**
系统已通过在模型名称前添加`openai/`前缀 (`openai/deepseek-chat`) 来解决此问题，以告知LiteLLM这是一个与OpenAI兼容的API。此修复已内置于代码中，您无需手动操作。

**详细修复逻辑 (`agents/research_agents.py`)：**
```python
llm = ChatOpenAI(
    model="openai/deepseek-chat",  # 关键修复点
    openai_api_key=config['api_key'],
    openai_api_base=config['base_url'] + '/v1',
    # ... 其他参数
)
```
您可以在`.env`文件中继续使用`deepseek-chat`，系统会自动处理前缀。

### 2. Cloudflare防护拦截

**错误信息：**
```
<!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title>
```

**原因：** DeepSeek API可能被Cloudflare防护系统拦截。

**解决方案：**
1.  **更换网络环境**：尝试使用不同的网络连接（如手机热点）。
2.  **使用代理**：配置HTTP代理绕过防护。
3.  **等待重试**：系统内置了重试机制，通常几分钟后可恢复。
4.  **联系DeepSeek支持**：如问题持续，请联系官方技术支持。

### 3. Connection Error 错误

**错误信息：** `Connection error`

**原因：** 网络连接问题。

**解决方案：**
1.  检查您的本地网络连接。
2.  确认DeepSeek API服务状态。
3.  尝试更换DNS服务器（如`8.8.8.8`或`1.1.1.1`）。
4.  检查防火墙或安全软件设置是否阻止了程序访问网络。

### 4. API Key 相关错误

**错误信息：** `Invalid API key`

**解决方案：**
1.  确认`.env`文件中的`OPENAI_API_KEY`格式正确（以`sk-`开头）。
2.  检查API密钥是否被禁用或过期。
3.  登录DeepSeek平台，确认账户余额充足。
4.  尝试重新生成一个新的API密钥。

### 5. 模板变量缺失错误

**错误信息：**
```
Missing required template variable 'Template variable 'validation_feedback' not found in inputs dictionary' in description
```

**根本原因：**
在任务描述模板中引用了 `{validation_feedback}` 变量，但在某些调用场景下没有提供这个变量值，导致模板渲染失败。

**解决方案：**
系统已修复此问题，通过以下方式解决：
1. 创建了修复版本的任务函数 `create_integrated_analysis_task_fixed`
2. 使用动态字符串构建而不是模板插值来处理可选参数
3. 在调用时根据是否有验证反馈来决定是否添加相关内容

**技术细节：**
- 修复文件：`tasks/research_tasks_fixed.py`
- 主要修改：使用 Python 字符串拼接代替模板变量引用
- 向后兼容：保持原有API接口不变

## 🔧 配置与安装

### 缺少.env文件

**现象：** 程序启动时提示找不到配置文件。

**解决方案：**
```bash
# 方法1：使用配置助手（如果项目提供）
# python setup_config.py

# 方法2：手动创建
cp env_example.txt .env
# 然后用您的编辑器打开.env文件，设置您的API密钥
```

### API连通性测试失败

如果怀疑是API连接问题，可以运行以下脚本进行测试：
```bash
# 运行连通性测试
python -c "
from utils.network_utils import check_api_connectivity
import os
from dotenv import load_dotenv
load_dotenv()
api_base = os.getenv('OPENAI_API_BASE', 'https://api.deepseek.com/v1')
api_key = os.getenv('OPENAI_API_KEY')
print('连通性测试结果:', check_api_connectivity(api_base, api_key))
"
```

## 🌐 网络问题

### 频繁超时

**解决方案：**
1.  在代码中适当增加请求的超时时间。
2.  使用更稳定的网络连接。
3.  为您的系统或终端配置HTTP代理。

### 速率限制

**错误信息：** `Rate limit exceeded`

**解决方案：**
1.  系统已内置基于`tenacity`的智能重试和速率限制器，会自动处理。
2.  如果问题依然存在，可以尝试降低并发请求数。
3.  如果您的用量很大，请考虑升级您的API套餐以获得更高的请求限额。

## 🔄 OpenAI SDK迁移与混合架构

为了提升性能和兼容性，项目采用了直接`openai` SDK调用和`langchain_openai`（用于CrewAI）的混合架构。

### 架构设计
```
┌─────────────────────────────────────────┐
│            应用架构                      │
├─────────────────────────────────────────┤
│  CrewAI智能体 (Agents)                  │
│  └── 使用 langchain_openai.ChatOpenAI     │
│                                         │
│  直接API调用 (e.g., Tests, Utils)       │
│  └── 使用 openai.OpenAI 客户端            │
└─────────────────────────────────────────┘
```

### 核心优势
1.  **性能优化**: 直接API调用减少了`langchain`的中间层开销。
2.  **功能完整**: 可以直接使用OpenAI SDK的所有最新功能。
3.  **向后兼容**: CrewAI智能体无需修改即可工作。
4.  **配置统一**: 单一的`.env`配置源管理所有API连接。

### 使用示例

**直接使用OpenAI SDK**
```python
from agents.research_agents import create_openai_client, get_model_config

# 创建客户端
client = create_openai_client()
config = get_model_config()

# 发送请求
response = client.chat.completions.create(
    model=config['model'],
    messages=[
        {"role": "system", "content": "You are a helpful assistant"},
        {"role": "user", "content": "Hello"},
    ],
    stream=False
)

print(response.choices[0].message.content)
```

**CrewAI智能体（自动处理兼容性）**
```python
from agents.research_agents import create_research_manager

# 创建智能体（内部自动使用兼容的LLM）
agent = create_research_manager()
```

## 📋 诊断步骤

### 1. 基础检查
```bash
# 检查配置文件是否存在
ls -la .env

# 验证配置内容（如果项目提供）
# python setup_config.py
```

### 2. 网络测试
```bash
# 测试域名解析和网络延迟
ping api.deepseek.com

# 使用curl测试API端点（请替换YOUR_API_KEY）
curl -H "Authorization: Bearer YOUR_API_KEY" https://api.deepseek.com/v1/models
```

### 3. 依赖检查
```bash
# 检查Python版本
python --version

# 检查关键依赖包版本
pip list | grep -E "(crewai|langchain|openai|litellm)"

# 如果怀疑依赖有问题，强制重新安装
pip install -r requirements.txt --upgrade --force-reinstall
```

## 🆘 获取帮助

### 日志分析
`research_assistant.log`文件包含了详细的错误信息，是排查问题的首选。
```bash
# 实时查看日志输出
tail -f research_assistant.log
```

### 联系支持
如果问题仍然无法解决：
1.  收集`research_assistant.log`中的相关错误日志。
2.  记录您输入的主题和复现问题的步骤。
3.  附上您的操作系统、Python版本等环境信息。
4.  在项目的GitHub页面提交Issue或联系技术支持。
